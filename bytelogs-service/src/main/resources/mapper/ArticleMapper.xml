<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="top.harrylei.community.service.article.repository.mapper.ArticleMapper">

    <!-- ArticleVO完整映射 -->
    <resultMap id="ArticleVOMap" type="top.harrylei.community.api.model.article.vo.ArticleVO">
        <!-- 文章基础信息 -->
        <id column="id" property="id"/>
        <result column="user_id" property="userId"/>
        <result column="article_type" property="articleType"/>
        <result column="title" property="title"/>
        <result column="short_title" property="shortTitle"/>
        <result column="picture" property="picture"/>
        <result column="summary" property="summary"/>
        <result column="source" property="source"/>
        <result column="source_url" property="sourceUrl"/>
        <result column="official" property="official"/>
        <result column="topping" property="topping"/>
        <result column="cream" property="cream"/>
        <result column="status" property="status"/>
        <result column="version_count" property="versionCount"/>
        <result column="deleted" property="deleted"/>
        <result column="create_time" property="createTime"/>
        <result column="update_time" property="updateTime"/>
        <result column="content" property="content"/>
        <result column="category_id" property="categoryId"/>

        <!-- 标签和分类信息将在服务层填充为SimpleVO对象 -->
    </resultMap>


    <!-- 分页查询文章基础信息  -->
    <select id="pageArticleVO" resultMap="ArticleVOMap">
        SELECT a.id, a.user_id, a.article_type, a.version_count, ad.title, ad.short_title, ad.picture,
        ad.summary, ad.source, ad.source_url, a.official, a.topping, a.cream,
        ad.status, a.deleted, a.create_time, a.update_time,
        ad.category_id
        FROM article a
        <choose>
            <when test="query.latest != null and query.latest == 1">
                <!-- 查询最新版本（个人创作中心：包括草稿） -->
                LEFT JOIN article_detail ad ON a.id = ad.article_id AND ad.latest = 1 AND ad.deleted = 0
            </when>
            <otherwise>
                <!-- 查询已发布版本（默认行为：向后兼容） -->
                LEFT JOIN article_detail ad ON a.id = ad.article_id AND ad.published = 1 AND ad.deleted = 0
            </otherwise>
        </choose>
        <if test="query.userName != null and query.userName != ''">
            INNER JOIN user_info ui ON a.user_id = ui.user_id AND ui.deleted = 0
        </if>
        <where>
            <if test="query.title != null and query.title != ''">
                AND ad.title LIKE CONCAT('%',
                #{query.title},
                '%'
                )
            </if>
            <if test="query.userId != null">
                AND a.user_id =
                #{query.userId}
            </if>
            <if test="query.userName != null and query.userName != ''">
                AND ui.user_name LIKE CONCAT('%',
                #{query.userName},
                '%'
                )
            </if>
            <if test="query.categoryId != null">
                AND ad.category_id =
                #{query.categoryId}
            </if>
            <if test="query.tagIdList != null and query.tagIdList.size() > 0">
                AND EXISTS (
                SELECT 1 FROM article_tag at
                WHERE at.article_id = a.id
                AND at.deleted = 0
                AND at.tag_id IN
                <foreach collection="query.tagIdList" item="tagId" open="(" separator="," close=")">
                    #{tagId}
                </foreach>
                )
            </if>
            <if test="query.status != null">
                AND ad.status =
                #{query.status}
            </if>
            <if test="query.deleted != null">
                AND a.deleted =
                #{query.deleted}
            </if>
            <if test="query.createTimeStart != null">
                AND a.create_time &gt;=
                #{query.createTimeStart}
            </if>
            <if test="query.createTimeEnd != null">
                AND a.create_time &lt;=
                #{query.createTimeEnd}
            </if>
        </where>
    </select>
</mapper>